import pandas as pd
import json
from ta.momentum import AwesomeOscillatorIndicator
from ta.momentum import StochasticOscillator
from ta.volume import AccDistIndexIndicator

# shamelessly stolen from https://medium.com/codex/bitcoin-trade-automation-with-awesome-oscillator-in-python-51f2c52c5b25
def implement_ao_crossover(price, ao):
    import numpy as np

    buy_price = []
    sell_price = []
    ao_signal = []
    signal = 0

    for i in range(len(ao)):
        if ao[i] > 0 and ao[i - 1] < 0:
            if signal != 1:
                buy_price.append(price[i])
                sell_price.append(None)
                signal = 1
                ao_signal.append(signal)
            else:
                buy_price.append(None)
                sell_price.append(None)
                ao_signal.append(0)
        elif ao[i] < 0 and ao[i - 1] > 0:
            if signal != -1:
                buy_price.append(None)
                sell_price.append(price[i])
                signal = -1
                ao_signal.append(signal)
            else:
                buy_price.append(None)
                sell_price.append(None)
                ao_signal.append(0)
        else:
            buy_price.append(None)
            sell_price.append(None)
            ao_signal.append(0)
    return buy_price, sell_price, ao_signal


def lambda_handler(event, context):
    # default confidence level
    confidence = 0
    return_data = {}

    # don't ask me why i need to stringify the json for read_json to be able to read it. whatever trevor.
    df_json = json.dumps(event["Payload"]["symbol_data"])
    df = pd.read_json(df_json)

    # easy reference to the name of the algo key in the payload
    selected_algo = list(event["Payload"]["ta_algo"].keys())[0]

    if selected_algo == "awesome-oscillator":
        # i wish the documentation for this library was even semi existent. it would make life better.
        df["awesome-oscillator"] = AwesomeOscillatorIndicator(
            high=df["High"], low=df["Low"], window1=5, window2=34, fillna=True
        ).awesome_oscillator()

        # data series for buy/sell price when we'd want to do those things, and signal marking those positions with a 1 or 0
        buy, sell, signal = implement_ao_crossover(
            df["Close"], df["awesome-oscillator"]
        )
        # put it into a dict
        data = {
            "awesome-oscillator-buy-price": buy,
            "awesome-oscillator-sell-price": sell,
            "awesome-oscillator-signal": signal,
            "awesome-oscillator": df["awesome-oscillator"].values.tolist(),
        }

        # look at the requested search period to see if we found a signal
        found = False
        for signal in data["awesome-oscillator-signal"][
            -event["Payload"]["search_period"] :
        ]:
            if signal == 1:
                found = True

        if found:
            confidence = 10

        return_data["confidence"] = confidence
        return_data["ta_data"] = data

        # return json.dumps(return_data)
        # return {"ta_confidence": confidence, "ta_data": data}

    elif selected_algo == "stoch":
        df["stoch"] = StochasticOscillator(
            close=df["Close"],
            high=df["High"],
            low=df["Low"],
            fillna=True,
        ).stoch()
        df["stoch_signal"] = StochasticOscillator(
            close=df["Close"],
            high=df["High"],
            low=df["Low"],
            fillna=True,
        ).stoch_signal()

        # not implemented yet
        confidence = 10
        return_data["confidence"] = confidence
        return_data["ta_data"] = None

    elif selected_algo == "accumulation-distribution":
        df["accumulation-distribution"] = AccDistIndexIndicator(
            close=df["Close"],
            high=df["High"],
            low=df["Low"],
            volume=df["Volume"],
            fillna=True,
        ).acc_dist_index()
        # not implemented yet
        confidence = 10
        return_data["confidence"] = confidence
        return_data["ta_data"] = None

    else:
        raise ValueError(
            f"Requested algorithm '{selected_algo}' is invalid/not implemented"
        )

    # not implemented in this library. i'll calculate it later maybe
    # elif selected_algo == "accelerator-oscillator":

    return return_data


payload = {
    "Payload": {
        "date_from": "2022-01-01T04:16:13+10:00",
        "date_to": "2022-03-30T04:16:13+10:00",
        "resolution": "1d",
        "search_period": 5,
        "notify_method": "pushover",
        "notify_recipient": "some-pushover-app-1",
        "target_ta_confidence": 7.5,
        "symbol": "bhp",
        "ta_algo": {
            "awesome-oscillator": {"strategy": "saucer", "direction": "bullish"}
        },
        "symbol_data": {
            "Open": {
                "1641168000000": 57.9464594475,
                "1641254400000": 57.8890743756,
                "1641340800000": 59.0462858116,
                "1641427200000": 59.5627213523,
                "1641513600000": 60.1461101493,
                "1641772800000": 60.3852020181,
                "1641859200000": 60.2513107736,
                "1641945600000": 64.0767884056,
                "1642032000000": 64.0767887775,
                "1642118400000": 63.35951573,
                "1642464000000": 63.9524660194,
                "1642550400000": 64.8418861535,
                "1642636800000": 65.5017808365,
                "1642723200000": 62.8430724822,
                "1642982400000": 60.4712736174,
                "1643068800000": 60.9685854639,
                "1643155200000": 61.5997932934,
                "1643241600000": 62.1353607676,
                "1643328000000": 61.7336874217,
                "1643587200000": 60.9685874218,
                "1643673600000": 61.1885521069,
                "1643760000000": 62.4413968703,
                "1643846400000": 63.6272944924,
                "1643932800000": 62.9769616596,
                "1644192000000": 64.6314866309,
                "1644278400000": 66.2955706485,
                "1644364800000": 65.4443953412,
                "1644451200000": 66.7068066545,
                "1644537600000": 65.5687223174,
                "1644796800000": 65.6069768546,
                "1644883200000": 64.1246089262,
                "1644969600000": 64.5071558408,
                "1645056000000": 65.1766180946,
                "1645142400000": 66.3433868642,
                "1645488000000": 66.3816487235,
                "1645574400000": 66.6494265131,
                "1645660800000": 63.5400009155,
                "1645747200000": 64.2900009155,
                "1646006400000": 66.9700012207,
                "1646092800000": 68.0899963379,
                "1646179200000": 71.0699996948,
                "1646265600000": 72.4899978638,
                "1646352000000": 70.7900009155,
                "1646611200000": 72.7099990845,
                "1646697600000": 69.5800018311,
                "1646784000000": 68.7600021362,
                "1646870400000": 69.8600006104,
                "1646956800000": 68.4199981689,
                "1647216000000": 67,
                "1647302400000": 63.9599990845,
                "1647388800000": 65.4599990845,
                "1647475200000": 66.5500030518,
                "1647561600000": 68.7699966431,
                "1647820800000": 70.4199981689,
                "1647907200000": 72.6399993896,
                "1647993600000": 71.6100006104,
                "1648080000000": 73.6900024414,
                "1648166400000": 74.2399978638,
                "1648425600000": 75.7900009155,
                "1648512000000": 74.25,
            },
            "High": {
                "1641168000000": 58.1281684373,
                "1641254400000": 58.9506456491,
                "1641340800000": 60.2321825767,
                "1641427200000": 59.9070151298,
                "1641513600000": 61.5615409935,
                "1641772800000": 60.6816780354,
                "1641859200000": 61.7910670771,
                "1641945600000": 64.2871909678,
                "1642032000000": 64.5740979576,
                "1642118400000": 64.2967615882,
                "1642464000000": 64.5932321832,
                "1642550400000": 65.78869037,
                "1642636800000": 66.5250964693,
                "1642723200000": 63.2064904592,
                "1642982400000": 61.8101894053,
                "1643068800000": 61.6762971973,
                "1643155200000": 62.5944116416,
                "1643241600000": 63.2064905099,
                "1643328000000": 61.8293229639,
                "1643587200000": 60.9685874218,
                "1643673600000": 62.2309955519,
                "1643760000000": 62.9195818603,
                "1643846400000": 63.6368602353,
                "1643932800000": 63.5316579986,
                "1644192000000": 65.8556390688,
                "1644278400000": 66.3433920689,
                "1644364800000": 66.008650104,
                "1644451200000": 67.844889275,
                "1644537600000": 66.3625111377,
                "1644796800000": 65.6069768546,
                "1644883200000": 64.6123523538,
                "1644969600000": 65.8652068338,
                "1645056000000": 65.5687260072,
                "1645142400000": 66.5250921952,
                "1645488000000": 66.7928808406,
                "1645574400000": 66.7737519843,
                "1645660800000": 63.8100013733,
                "1645747200000": 67.0699996948,
                "1646006400000": 68.0699996948,
                "1646092800000": 68.9599990845,
                "1646179200000": 71.9800033569,
                "1646265600000": 73.5800018311,
                "1646352000000": 73.1399993896,
                "1646611200000": 73.2300033569,
                "1646697600000": 70.6999969482,
                "1646784000000": 70.1999969482,
                "1646870400000": 71.25,
                "1646956800000": 69.6200027466,
                "1647216000000": 67.2200012207,
                "1647302400000": 64.8199996948,
                "1647388800000": 66.9700012207,
                "1647475200000": 67.9400024414,
                "1647561600000": 68.9100036621,
                "1647820800000": 72.0999984741,
                "1647907200000": 73,
                "1647993600000": 72.9899978638,
                "1648080000000": 74.5800018311,
                "1648166400000": 75.3899993896,
                "1648425600000": 75.8700027466,
                "1648512000000": 75.7600021362,
            },
            "Low": {
                "1641168000000": 57.5160922104,
                "1641254400000": 57.8030009305,
                "1641340800000": 59.0271579736,
                "1641427200000": 58.7211183943,
                "1641513600000": 60.0696024446,
                "1641772800000": 59.4862155195,
                "1641859200000": 59.7348700913,
                "1641945600000": 63.2160539677,
                "1642032000000": 63.8855176998,
                "1642118400000": 63.2064930198,
                "1642464000000": 63.1969328262,
                "1642550400000": 64.6984292003,
                "1642636800000": 64.9566502152,
                "1642723200000": 62.1162292315,
                "1642982400000": 59.5053415393,
                "1643068800000": 60.1174167761,
                "1643155200000": 61.217243846,
                "1643241600000": 62.0684151587,
                "1643328000000": 60.4617135498,
                "1643587200000": 60.0982908688,
                "1643673600000": 61.045098796,
                "1643760000000": 61.9823360694,
                "1643846400000": 62.5944131484,
                "1643932800000": 62.7761248396,
                "1644192000000": 64.1341701427,
                "1644278400000": 64.9279612042,
                "1644364800000": 64.8036292321,
                "1644451200000": 66.5824811828,
                "1644537600000": 65.3678855008,
                "1644796800000": 64.583661304,
                "1644883200000": 63.1969288949,
                "1644969600000": 64.5071558408,
                "1645056000000": 64.6410459236,
                "1645142400000": 65.6069779077,
                "1645488000000": 65.1861861601,
                "1645574400000": 65.6739250435,
                "1645660800000": 62.2700004578,
                "1645747200000": 64.0899963379,
                "1646006400000": 66.9199981689,
                "1646092800000": 67.5699996948,
                "1646179200000": 70.6600036621,
                "1646265600000": 72.2900009155,
                "1646352000000": 70.7699966431,
                "1646611200000": 71.6800003052,
                "1646697600000": 69.0500030518,
                "1646784000000": 68.3799972534,
                "1646870400000": 69.4700012207,
                "1646956800000": 68.3499984741,
                "1647216000000": 65.0400009155,
                "1647302400000": 63.3699989319,
                "1647388800000": 65.3099975586,
                "1647475200000": 66.0699996948,
                "1647561600000": 67.6699981689,
                "1647820800000": 70.3700027466,
                "1647907200000": 70.6299972534,
                "1647993600000": 71.4400024414,
                "1648080000000": 73.6500015259,
                "1648166400000": 74.2399978638,
                "1648425600000": 74.6200027466,
                "1648512000000": 73.4700012207,
            },
            "Close": {
                "1641168000000": 57.7073669434,
                "1641254400000": 58.6446075439,
                "1641340800000": 59.3427581787,
                "1641427200000": 59.409702301,
                "1641513600000": 61.5519752502,
                "1641772800000": 60.3947677612,
                "1641859200000": 61.6763000488,
                "1641945600000": 64.2202453613,
                "1642032000000": 64.1724243164,
                "1642118400000": 64.0481033325,
                "1642464000000": 63.5507850647,
                "1642550400000": 65.4922180176,
                "1642636800000": 65.0618515015,
                "1642723200000": 62.1353607178,
                "1642982400000": 61.7910652161,
                "1643068800000": 61.0929145813,
                "1643155200000": 61.6571731567,
                "1643241600000": 62.9291496277,
                "1643328000000": 61.370262146,
                "1643587200000": 60.8251304626,
                "1643673600000": 62.1831741333,
                "1643760000000": 62.6613578796,
                "1643846400000": 62.871761322,
                "1643932800000": 63.2734413147,
                "1644192000000": 65.4635238647,
                "1644278400000": 66.1425552368,
                "1644364800000": 65.8938903809,
                "1644451200000": 66.8885192871,
                "1644537600000": 65.9034576416,
                "1644796800000": 65.2818145752,
                "1644883200000": 64.5740966797,
                "1644969600000": 65.7313156128,
                "1645056000000": 64.9566497803,
                "1645142400000": 66.3146896362,
                "1645488000000": 65.7408752441,
                "1645574400000": 65.7600021362,
                "1645660800000": 63.5,
                "1645747200000": 67.0599975586,
                "1646006400000": 67.7900009155,
                "1646092800000": 68.5,
                "1646179200000": 71.9700012207,
                "1646265600000": 73,
                "1646352000000": 73.1200027466,
                "1646611200000": 72.4000015259,
                "1646697600000": 69.5699996948,
                "1646784000000": 69.8399963379,
                "1646870400000": 71.2099990845,
                "1646956800000": 68.5500030518,
                "1647216000000": 65.4899978638,
                "1647302400000": 64.7799987793,
                "1647388800000": 66.8399963379,
                "1647475200000": 67.9000015259,
                "1647561600000": 68.8000030518,
                "1647820800000": 71.6399993896,
                "1647907200000": 71.0299987793,
                "1647993600000": 72.9599990845,
                "1648080000000": 74.2699966431,
                "1648166400000": 75.3399963379,
                "1648425600000": 75.5899963379,
                "1648512000000": 75.6299972534,
            },
            "Volume": {
                "1641168000000": 1584400,
                "1641254400000": 3321300,
                "1641340800000": 6382600,
                "1641427200000": 2926300,
                "1641513600000": 3727700,
                "1641772800000": 4356900,
                "1641859200000": 4215000,
                "1641945600000": 4599500,
                "1642032000000": 5200900,
                "1642118400000": 5379300,
                "1642464000000": 6245200,
                "1642550400000": 4511700,
                "1642636800000": 8650500,
                "1642723200000": 9531000,
                "1642982400000": 7971000,
                "1643068800000": 7583800,
                "1643155200000": 6814500,
                "1643241600000": 10163300,
                "1643328000000": 12077100,
                "1643587200000": 8622300,
                "1643673600000": 9333000,
                "1643760000000": 7129300,
                "1643846400000": 11194000,
                "1643932800000": 6727600,
                "1644192000000": 6401300,
                "1644278400000": 9667500,
                "1644364800000": 9618900,
                "1644451200000": 7782400,
                "1644537600000": 5308100,
                "1644796800000": 6593500,
                "1644883200000": 6880200,
                "1644969600000": 6314300,
                "1645056000000": 6195500,
                "1645142400000": 6099500,
                "1645488000000": 4544600,
                "1645574400000": 5315800,
                "1645660800000": 6531000,
                "1645747200000": 5642500,
                "1646006400000": 3760700,
                "1646092800000": 4749600,
                "1646179200000": 5204000,
                "1646265600000": 5053500,
                "1646352000000": 5597600,
                "1646611200000": 6735300,
                "1646697600000": 7243600,
                "1646784000000": 9496000,
                "1646870400000": 5434800,
                "1646956800000": 4715600,
                "1647216000000": 6665200,
                "1647302400000": 5259200,
                "1647388800000": 5112200,
                "1647475200000": 3809300,
                "1647561600000": 4456000,
                "1647820800000": 5374900,
                "1647907200000": 6015800,
                "1647993600000": 3804800,
                "1648080000000": 3553600,
                "1648166400000": 2933500,
                "1648425600000": 5575500,
                "1648512000000": 4375200,
            },
            "Dividends": {
                "1641168000000": 0,
                "1641254400000": 0,
                "1641340800000": 0,
                "1641427200000": 0,
                "1641513600000": 0,
                "1641772800000": 0,
                "1641859200000": 0,
                "1641945600000": 0,
                "1642032000000": 0,
                "1642118400000": 0,
                "1642464000000": 0,
                "1642550400000": 0,
                "1642636800000": 0,
                "1642723200000": 0,
                "1642982400000": 0,
                "1643068800000": 0,
                "1643155200000": 0,
                "1643241600000": 0,
                "1643328000000": 0,
                "1643587200000": 0,
                "1643673600000": 0,
                "1643760000000": 0,
                "1643846400000": 0,
                "1643932800000": 0,
                "1644192000000": 0,
                "1644278400000": 0,
                "1644364800000": 0,
                "1644451200000": 0,
                "1644537600000": 0,
                "1644796800000": 0,
                "1644883200000": 0,
                "1644969600000": 0,
                "1645056000000": 0,
                "1645142400000": 0,
                "1645488000000": 0,
                "1645574400000": 0,
                "1645660800000": 3,
                "1645747200000": 0,
                "1646006400000": 0,
                "1646092800000": 0,
                "1646179200000": 0,
                "1646265600000": 0,
                "1646352000000": 0,
                "1646611200000": 0,
                "1646697600000": 0,
                "1646784000000": 0,
                "1646870400000": 0,
                "1646956800000": 0,
                "1647216000000": 0,
                "1647302400000": 0,
                "1647388800000": 0,
                "1647475200000": 0,
                "1647561600000": 0,
                "1647820800000": 0,
                "1647907200000": 0,
                "1647993600000": 0,
                "1648080000000": 0,
                "1648166400000": 0,
                "1648425600000": 0,
                "1648512000000": 0,
            },
            "Stock Splits": {
                "1641168000000": 0,
                "1641254400000": 0,
                "1641340800000": 0,
                "1641427200000": 0,
                "1641513600000": 0,
                "1641772800000": 0,
                "1641859200000": 0,
                "1641945600000": 0,
                "1642032000000": 0,
                "1642118400000": 0,
                "1642464000000": 0,
                "1642550400000": 0,
                "1642636800000": 0,
                "1642723200000": 0,
                "1642982400000": 0,
                "1643068800000": 0,
                "1643155200000": 0,
                "1643241600000": 0,
                "1643328000000": 0,
                "1643587200000": 0,
                "1643673600000": 0,
                "1643760000000": 0,
                "1643846400000": 0,
                "1643932800000": 0,
                "1644192000000": 0,
                "1644278400000": 0,
                "1644364800000": 0,
                "1644451200000": 0,
                "1644537600000": 0,
                "1644796800000": 0,
                "1644883200000": 0,
                "1644969600000": 0,
                "1645056000000": 0,
                "1645142400000": 0,
                "1645488000000": 0,
                "1645574400000": 0,
                "1645660800000": 0,
                "1645747200000": 0,
                "1646006400000": 0,
                "1646092800000": 0,
                "1646179200000": 0,
                "1646265600000": 0,
                "1646352000000": 0,
                "1646611200000": 0,
                "1646697600000": 0,
                "1646784000000": 0,
                "1646870400000": 0,
                "1646956800000": 0,
                "1647216000000": 0,
                "1647302400000": 0,
                "1647388800000": 0,
                "1647475200000": 0,
                "1647561600000": 0,
                "1647820800000": 0,
                "1647907200000": 0,
                "1647993600000": 0,
                "1648080000000": 0,
                "1648166400000": 0,
                "1648425600000": 0,
                "1648512000000": 0,
            },
        },
    }
}

if __name__ == "__main__":
    lambda_handler(payload, None)
